## 23.11 ARP와 RARP
RARP(Reverse Address Resolution Protocol: 역 주소 결정 프로토콜)는 주어진 MAC 주소에서 IP주소를 얻는데 사용됩니다. 일반적으로, 네트워크 관리자는 물리적 기계의 주소(MAC 주소)를 해당하는 인터넷 프로토콜 주소(IP 주소)로 매핑하는 로컬 영역 네트워크 게이트웨이 라우터에 주소 결정 프로토콜(Address Resolution Protocol: ARP)을 생성합니다. 새로운 기계가 설치되면 설치된 기계의 RARP 클라이언트 프로그램은 라우터에 있는 RARP 서버로부터 IP 주소를 전달받습니다. 항목이 라우터 테이블에 설정되어 있다고 가정하면 RARP서버는 설정된 기계에 IP를 반환하고 이 기계는 나중에 사용할 수 있도록 저장할 수 있습니다. 주소 확인 프로토콜(ARP)은 역 주소 결정 프로토콜(RARP)과는 완전히 다른 기능을 제공합니다.
ARP는 IP 데이터 패킷을 감싸는 이더넷 패킷을 만들기 위해 IP 주소에서 MAC 주소를 확인하는데 사용됩니다. 3계층의 주소는 논리적인 주소이고 계층 2의 주소는 물리적 주소입니다. 컴퓨터는 여러 개의 계층 3 주소를 가질 수 있으나 계층 2의 주소는 하나의 LAN 인터페이스당 하나만 가질 수 있습니다. 계층 3에서 데이터가 향하는 호스트로 어드레싱됩니다. 계층 2에서는 데이터가 다음 홉(next hop)으로 어드레싱됩니다. 이것은 단지 호스트의 계층 3의 주소만 알면 (예를 들어 DNS를 이용하여 확인하실 수 있습니다)되고 하드웨어에 대해서는 알 필요가 없어 편리합니다. (목적지 호스트로 어드레싱된)계층 3패킷은 (다음 홉으로 어드레싱된) 계층 2프레임 안에 캡슐화됩니다.

### 로컬 호스트에 대한 ARP 동작
데이터가 네트워크 계층(Network layer)에 도착하면 목적지의 IP주소를 넣습니다. 이정보는 모두 데이터 링크 계층(Data link layer)까지 전달된 데이터 링크 프레임 내에 위치하게 됩니다. IP 주소에 기반하여 컴퓨터는 목적지 IP가 로컬 IP인지 아닌지 알아낼 수 있어야 합니다. IP가 로컬인 경우 컴퓨터는 MAC 주소를 자신의 ARP 테이블 (이전 ARP 요청에 대한 응답이 캐시되어 있는 테이블)에서 찾을 것입니다.
만일 거기에 존재하지 않으면 컴퓨터는 목적지 IP의 MAC 주소를 찾기 위해 ARP 요청을 브로드 캐스트합니다. 이때 요청이 브로드캐스트되므로 LAM에 있는 모든 기계가 수신하고 내용을 검사합니다. 만일 요청에 대한 IP 주소가 자신일 경우 해당하는 기계가 응답할 것입니다. 이 정보를 수신하면 컴퓨터는 새로운 정보를 포함하도록 ARP 테이블을 갱신한 후(목적지 호스트의 MAC 주소가 기록된) 전송하고자 하던 프레임을 전송할 것입니다.

### 원격 호스트에 대한 ARP 동작 
IP가 로컬이 아닌 경우 게이트웨이(라우터)가 이것을 받아봅니다(ARP 요청은 브로드캐스트되기 때문에 LAN에 있는 모든 호스트가 요청을 볼 수 있습니다). 라우터는 자신의 라우팅 테이블을 보고 목적지 네트워크에 대한 경로를 가지고 있을 경우 자신의 MAC 주소로 응답합니다. 이것은 컴퓨터가 네트워크 토폴로지(망의 접속 형태)에 대해 아무것도 모를 경우입니다. 대부분의 경우 컴퓨터는 서브넷 마스크를 알고 기본케이트웨이가 설정되어 있습니다. 이 때문에 컴퓨터는 패킷이 로컬 네트워크로 향하지 않는 것을 알아 낼 수 있습니다. 이제 컴퓨터는 (게이트웨이의 MAC 주소가 자신의 ARP 테이블에 있거나 없을 경우 앞에서 설명한 대로 ARP 요청을 보내어) 기본 게이트웨이의 MAC 주소를 사용할 것입니다. 기본 게이트웨이가 프레임을 수신하면 자신의 MAC 주소와 일치하는지 검사할 것이기 때문에 프레임에 반드시 있어야 합니다. 라우터는 데이터 링크 프레임의 캡슐을 풀고 풀린 데이터를 네트워크 계층으로 올려 보냅니다.
네트워크 계층에서 라우터는 (IP패킷의 헤더가 있는) 목적지 IP주소가 자신과 일치하지 않는다는 것을 알게 될 것입니다(컴퓨터가 IPㅣ패킷을 생성한 이후 이제까지 과정에서 IP주소는 전혀 손대지 않았다는 것을 기억하십시오). 네트워크 계층에서 라우터는 이 패킷이 라우트될 예정인 패킷이라는 것을 알게 될 것입니다. 이제 라우터는 패킷을 보낼 인터페이스를 알아내기 위해 목적지 IP와 가장 가깝게 일치하는 것을 자신의 라우팅 테이블에서 찾을 것입니다. 일치하는 것을 발견하면 라우터는 새로운 데이터 링크 프레임을 다음 홉으로 어드레싱하여 생성할 것입니다(라우터가 다음 홉에 대한 하드웨어 주소를 찾지 못하면 적절한 수단을 사용합니다. 이부분은 문항(문제) 섹션을 참조). 이 프레임은 원래의 IP패킷 전체를 그대로 포함한 채 알맞은 인터페이스로 전송됩니다(목적지 IP주소는 여전히 변경되지 않습니다).
이 과정은 목적지 네트워크에 접속된 라우터에 도달할 때까지 도중의 각 라우터에서 계속됩니다. 패킷을 목적지에 연결된 라우터는 네트워크에 직접 연결된 호스트로 어드레싱합니다(주소에 대해 획득할 수 있는 가장 가까운 매칭, 패킷에 문제가 있다면 되돌아 오도록 어드레싱됩니다.)여기서 라우터는 목적지 IP주소의 MAC 주소를 위해 ARP 요청을 보낸 후(아직 자신의 테이블에 정보가 존재하지 않을 경우를 가정했을 경우), 목적지의 MAC 주소를 패킷에 지정합니다.
